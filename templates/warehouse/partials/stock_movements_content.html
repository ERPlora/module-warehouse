{% load djicons i18n %}

<div x-data="{
    view: '{{ current_view|default:'table' }}',
    panelOpen: false,
    selectedIds: [],
    selectAll: false,
    editUrl: '',
    deleteConfirm: false,
    deleteTarget: null,
    toggleSelect(id) {
        const idx = this.selectedIds.indexOf(id);
        if (idx > -1) this.selectedIds.splice(idx, 1);
        else this.selectedIds.push(id);
        this.selectAll = false;
    },
    toggleAll(ids) {
        if (this.selectAll) this.selectedIds = [];
        else this.selectedIds = [...ids];
        this.selectAll = !this.selectAll;
    },
    clearSelection() { this.selectedIds = []; this.selectAll = false; },
    openPanel(url) {
        this.editUrl = url;
        htmx.ajax('GET', url, { target: '#stock_movement-panel-content', swap: 'innerHTML' });
        this.panelOpen = true;
    },
    closePanel() { this.panelOpen = false; },
    confirmDelete() {
        if (this.deleteTarget) {
            htmx.ajax('POST', this.deleteTarget.url, {
                target: '#datatable-body', swap: 'innerHTML',
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}' }
            });
        }
        this.deleteConfirm = false;
        this.deleteTarget = null;
    }
}">

    <div class="datatable glass mt-5" id="stock_movements-datatable">
        <div class="datatable-toolbar">
            <div class="datatable-toolbar-start">
                <label class="input input-sm datatable-search">
                    {% icon "search-outline" %}
                    <input type="search" name="q"
                           placeholder="{% trans 'Search...' %}"
                           value="{{ search_query|default:'' }}"
                           autocomplete="off"
                           hx-get="{% url 'warehouse:stock_movements_list' %}"
                           hx-target="#datatable-body"
                           hx-include="#stock_movements-datatable"
                           hx-trigger="input changed delay:300ms, search">
                </label>
            </div>
            <div class="datatable-toolbar-end">
                <button class="btn btn-sm btn-circle color-primary"
                        @click="openPanel('{% url 'warehouse:stock_movement_add' %}')"
                        title="{% trans 'Add' %}">
                    {% icon "add-outline" %}
                </button>
                <details class="dropdown" x-data="{ open: false }" :open="open" @click.outside="open = false">
                    <summary class="datatable-export-btn" @click.prevent="open = !open" title="{% trans 'Export' %}">
                        {% icon "download-outline" %}
                    </summary>
                    <div class="dropdown-menu dropdown-menu-right">
                        <a class="dropdown-item" href="#"
                           @click.prevent="open = false; window.location.href = '{% url 'warehouse:stock_movements_list' %}?export=csv&' + new URLSearchParams({q: document.querySelector('[name=q]')?.value || ''}).toString()">
                            {% icon "document-text-outline" %} {% trans "Export as CSV" %}
                        </a>
                        <a class="dropdown-item" href="#"
                           @click.prevent="open = false; window.location.href = '{% url 'warehouse:stock_movements_list' %}?export=excel&' + new URLSearchParams({q: document.querySelector('[name=q]')?.value || ''}).toString()">
                            {% icon "document-text-outline" %} {% trans "Export as Excel" %}
                        </a>
                    </div>
                </details>
            </div>
        </div>

        <!-- Bulk Actions -->
        <div class="datatable-bulk" x-show="selectedIds.length > 0" x-cloak>
            <div class="datatable-bulk-info">
                <span class="datatable-bulk-count" x-text="selectedIds.length"></span>
                <span>{% trans "selected" %}</span>
            </div>
            <div class="datatable-bulk-actions">
                
                
                <button class="datatable-bulk-btn datatable-bulk-btn-danger"
                        hx-post="{% url 'warehouse:stock_movements_bulk_action' %}"
                        hx-target="#datatable-body" hx-include="#stock_movements-datatable"
                        :hx-vals="JSON.stringify({ids: selectedIds.join(','), action: 'delete'})"
                        @htmx:after-request="clearSelection()">
                    {% icon "trash-outline" %} {% trans "Delete" %}
                </button>
                <button class="datatable-bulk-clear" @click="clearSelection()">
                    {% icon "close-outline" %}
                </button>
            </div>
        </div>

        {% csrf_token %}
        <input type="hidden" name="sort" value="{{ sort_field|default:'name' }}">
        <input type="hidden" name="dir" value="{{ sort_dir|default:'asc' }}">
        <input type="hidden" name="view" :value="view">
        <input type="hidden" name="per_page" value="{{ per_page|default:'10' }}">

        <div id="datatable-body">
            {% include "warehouse/partials/stock_movements_list.html" %}
        </div>
    </div>

    <!-- Side Sheet -->
    <div class="sheet-backdrop" :class="{ 'is-open': panelOpen }" @click.self="closePanel()">
        <div class="side-sheet side-sheet-right" id="stock_movement-panel-content"></div>
    </div>

    <!-- Delete Modal -->
    <div class="modal-backdrop" :data-state="deleteConfirm ? 'open' : 'closed'" @click.self="deleteConfirm = false; deleteTarget = null">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h3 class="modal-title">{% trans "Confirm Delete" %}</h3>
                <button class="modal-close" @click="deleteConfirm = false; deleteTarget = null">{% icon "close-outline" %}</button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-base-content/70">
                    {% trans "Are you sure you want to delete" %} <strong x-text="deleteTarget?.name"></strong>?
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost btn-sm" @click="deleteConfirm = false; deleteTarget = null">{% trans "Cancel" %}</button>
                <button class="btn btn-sm color-error" @click="confirmDelete()">{% icon "trash-outline" %} {% trans "Delete" %}</button>
            </div>
        </div>
    </div>
</div>
